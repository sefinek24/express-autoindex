/**
* @license
* express-autoindex
* Copyright (c) 2023-present, c-bertran (Clément Bertrand) (https://github.com/c-bertran)
*
* THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
* IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
* FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
* AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
* LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
* OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
* THE SOFTWARE.
*/
"use strict";var e=require("chardet"),t=require("fs"),s=require("fs/promises"),r=require("http"),i=require("mime"),o=require("os"),a=require("path");function n(e){var t=Object.create(null);return e&&Object.keys(e).forEach((function(s){if("default"!==s){var r=Object.getOwnPropertyDescriptor(e,s);Object.defineProperty(t,s,r.get?r:{enumerable:!0,get:function(){return e[s]}})}})),t.default=e,Object.freeze(t)}var h=n(i);class d{isProduction;errorCode;htmlPage;month;savePage;savePageDeadline;dateFormat;dateRegexParse;options;jsonOption;path;root;constructor(e,s,i){if(this.isProduction=void 0!==process.env.NODE_ENV&&"production"===process.env.NODE_ENV,this.errorCode=(()=>{const e=new Map([["EBADF",{message:"fd is not a valid open file descriptor"}],["EFAULT",{message:"Bad address"}],["EINVAL",{message:"Invalid flag specified in flag"}],["ELOOP",{message:"Too many symbolic links encountered while traversing the path"}],["ENOMEM",{message:"Out of memory"}],["EOVERFLOW",{message:"pathname or fd refers to a file whose size, inode number, or number of blocks cannot be represented in, respectively, the types off_t, ino_t, or blkcnt_t.\nThis error can occur when, for example, an application compiled on a 32-bit platform without -D_FILE_OFFSET_BITS=64 calls stat() on a file whose size exceeds (1<<31)-1 bytes."}]]),t=new Map([["EACCES",{message:"Permission denied"}],["EADDRINUSE",{message:"Address already in use"}],["ECONNREFUSED",{message:"Connection refused"}],["ECONNRESET",{message:"Connection reset by peer"}],["EEXIST",{message:"File exists"}],["EISDIR",{message:"Is a directory"}],["EMFILE",{message:"Too many open files in system"}],["ENAMETOOLONG",{message:r.STATUS_CODES[414],httpCode:414}],["ENOENT",{message:"No such file or directory",httpCode:404}],["ENOTDIR",{message:"Not a directory",httpCode:404}],["ENOTEMPTY",{message:"Directory not empty"}],["ENOTFOUND",{message:"DNS lookup failed"}],["EPERM",{message:"Operation not permitted",httpCode:403}],["EPIPE",{message:"Broken pipe"}],["ETIMEDOUT",{message:r.STATUS_CODES[408],httpCode:408}]]),s=new Map([...e,...t]);return s.forEach(((e,t)=>{e.httpCode||s.set(t,{message:e.message,httpCode:500})})),s})(),this.htmlPage='<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><title>{{title}}</title><meta name="viewport" content="width=device-width,initial-scale=1"><style>h1{font-family:"Times New Roman",sans-serif}table{font-family:"Courier New",sans-serif;font-size:12px}tr td:first-child{padding-right:37px}tr td:last-child:not(.back){text-align:right;padding-left:37px}</style></head><body><h1>{{title}}</h1><hr><table>{{content}}</table><hr></body></html>',this.month=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],this.savePage=[],this.savePageDeadline=3e5,this.dateFormat=new Map([["%wd",e=>new Intl.DateTimeFormat("en-US",{calendar:"iso8601",timeZone:"UTC",weekday:"short"}).format(e)],["%d",e=>e.day],["%mo",e=>this.month[Number(e.month)-1]],["%y",e=>e.year],["%h",e=>e.hours],["%mi",e=>e.minutes],["%s",e=>e.seconds],["%ms",e=>e.milliseconds]]),this.dateRegexParse="^(?<year>\\d{4})-(?<month>\\d{2})-(?<day>\\d{2})T(?<hours>\\d{2}):(?<minutes>\\d{2}):(?<seconds>\\d{2})\\.(?<milliseconds>\\d{3})Z$",this.options={alwaysThrowError:i?.alwaysThrowError??!1,cache:i?.cache,dateFormat:i?.dateFormat??"%d?-%mo-%y %h:%mi",dirAtTop:i?.dirAtTop??!0,displayDate:i?.displayDate??!0,displayDotfile:i?.displayDotfile??!1,displaySize:i?.displaySize??!0,exclude:i?.exclude,json:i?.json??!1,strict:i?.strict??!0},this.jsonOption=i?.customJsonFormat,this.path=s.length?s:void 0,this.root=e,i?.customTemplate){const e=a.resolve(".",i.customTemplate);try{this.htmlPage=t.readFileSync(e,{encoding:"utf-8",flag:"r"})}catch(t){throw new Error(`customTemplate path is incorrect: ${e}`)}}if(this.options?.cache&&(this.savePageDeadline=this.options.cache),!e)throw new TypeError("root is required");t.accessSync(e,t.constants.R_OK);if(!t.statSync(e).isDirectory())throw new Error("root is not a directory");if(this.path&&"/"!==this.path.charAt(0))throw new Error(`path '${this.path}' not start with /`)}formatError(e,t){let s=t??"";return this.isProduction||(t&&(s+="\n→ "),s+=`(${e.message})`),s}throwError(e){return!!this.options.alwaysThrowError||e>=500}error(e,t){if("number"==typeof e)return r.STATUS_CODES[e]&&t.status(e),this.throwError(e)?new Error(r.STATUS_CODES[e]??`System error code ${e} not recognized`):void 0;const s=this.errorCode.get(e.code??"__DEFAULT__");return s?(t.status(s.httpCode),this.throwError(s.httpCode)?new Error(this.formatError(e,s.message)):void 0):new Error(this.formatError(e,`System error code ${e} not recognized`))}parsePath(e){return"/"===(e=a.posix.normalize(e.normalize())).charAt(e.length-1)&&e.length>1&&(e=e.slice(0,e.length-1)),e}serve(e,t,r){const i=e=>"/"===e.at(0)?e.slice(1):e,n=this.path?i(e).replace(i(this.path),""):i(e),h=n.split("/").filter((e=>e.length)),d={path:e,savePath:n,serverPath:decodeURI("win32"===o.platform()?a.win32.normalize(a.win32.resolve(this.root,...h)):a.posix.normalize(a.posix.resolve(this.root,...h))),title:i(n).length?`/${decodeURI(i(n))}/`:"/"};s.stat(d.serverPath).then((e=>{if(e.isFile())this.file(d,e,t,r);else{if(!e.isDirectory()){const e=new Error(`ENOENT: no such file or directory, stat '${d.serverPath}'`);throw e.code="ENOENT",e.syscall="stat",e.errno=-4058,e}this.directory(d,t,r)}})).catch((e=>r(this.error(e,t))))}send(e,t){if(t.status(200),"string"==typeof e)return t.setHeader("Content-Length",Buffer.byteLength(e)),t.send(e);t.setHeader("Content-Length",Buffer.byteLength(JSON.stringify(e))),t.json(e)}dateToHTMLDate(e){const t=new RegExp(this.dateRegexParse,"gm").exec(e.toISOString());let s;if(t&&t.groups){const r={day:new Intl.DateTimeFormat("en-US",{calendar:"iso8601",timeZone:"UTC",weekday:"short"}).format(e),dayNumber:t.groups.day,month:this.month[Number(t.groups.month)-1],year:t.groups.year,hours:t.groups.hours,minutes:t.groups.minutes,seconds:t.groups.seconds};s=`${r.day}, ${r.dayNumber} ${r.month} ${r.year} ${r.hours}:${r.minutes}:${r.seconds} GMT`}return s}file(s,r,i,o){const a=h.getType(s.serverPath)??"application/octet-stream",n=this.dateToHTMLDate(r.mtime);e.detectFile(s.serverPath,{sampleSize:256}).then((e=>{i.setHeader("Content-Length",r.size),i.setHeader("Content-Type",`${a}; charset=${e??"UTF-8"}`),n&&(i.setHeader("Last-Modified",n),i.writeHead(200),t.createReadStream(s.serverPath).pipe(i))})).catch((e=>o(this.error(e,i))))}checkSavePage(e){const t=(new Date).getTime();for(const s in this.savePage)if(e===this.savePage[s].path){if(this.savePage[s].deadline.getTime()>=t)return this.savePage[s];this.savePage.splice(Number(s));break}}genTime(e){const t=new RegExp(this.dateRegexParse,"gm").exec(e.mtime.toISOString());let s=this.options.dateFormat,r=0;if(t&&t.groups)for(const e of this.dateFormat)for(;(r=s.indexOf(e[0]))>-1;){const i=e[1](t.groups),o=r+e[0].length;!i||i.length<=0?("?"===s.charAt(o)&&(s=s.slice(0,o)+s.slice(o+2)),s=s.replace(e[0],"")):("?"===s.charAt(o)&&(s=s.slice(0,o)+s.slice(o+1)),s=s.replace(e[0],i))}return s}generateRow(e){let t="<tr>";return t+=`<td class="link"><a href="${e.el.dirent[0]}">${e.el.dirent[1]}</a></td>`,this.options.displayDate&&(t+=`<td class="time">${e.el.time.replace(/[\x26\x0A<>'"]/g,(e=>`&#${e.charCodeAt(0)};`))}</td>`),this.options.displaySize&&(t+=`<td class="size">${e.el.size}</td>`),t+="</tr>",t}generateJson(e){const t=e=>Object.prototype.hasOwnProperty.call(this.jsonOption,e),s={};return this.jsonOption?(t("isDir")&&(s[this.jsonOption.isDir]=e.dirent.isDirectory()),t("name")&&(s[this.jsonOption.name]=e.el.dirent[1]),t("path")&&(s[this.jsonOption.path]=e.el.dirent[0]),t("time")&&(s[this.jsonOption.time]=e.el.time),t("size")&&(s[this.jsonOption.size]=Number(e.el.size))):(s.isDir=e.dirent.isDirectory(),s.name=e.el.dirent[1],s.path=e.el.dirent[0],s.time=e.el.time,s.size=Number(e.el.size)),s}directory(e,t,r){const i=this.checkSavePage(e.savePath),o=[],n=[],h=[],d=[];let c;if(void 0!==this.options.cache&&i)return this.send(i.data,t);s.readdir(e.serverPath,{encoding:"utf-8",withFileTypes:!0}).then((async r=>{for(const t of r){if(!t.isDirectory()&&!t.isFile()||!this.options.displayDotfile&&"."===t.name.charAt(0)||this.options.exclude&&this.options.exclude.test(t.name))continue;const r=await s.stat(a.resolve(e.serverPath,t.name));o.push({dirent:t,el:{dirent:[`${this.path?this.parsePath(`${this.path}${e.title}${t.name}`):this.parsePath(this.path)}`,`${t.name}${t.isDirectory()?"/":""}`],time:this.genTime(r),size:t.isFile()?String(r.size):"-"}})}if(this.options.json)c=o.map((e=>this.generateJson(e)));else{0!==e.title.localeCompare("/")&&d.push(`<tr><td class="back"><a href="${e.path.replace(/[^/]+$/,"")}">../</a></td></tr>`);for(const e of o)this.options.dirAtTop?e.dirent.isDirectory()?h.push(this.generateRow(e)):e.dirent.isFile()&&n.push(this.generateRow(e)):d.push(this.generateRow(e));this.options.dirAtTop&&d.push(...h,...n),c=this.htmlPage.replaceAll(/{{\s?title\s?}}/g,`Index of ${e.title}`).replaceAll(/{{\s?content\s?}}/g,d.join(""))}return void 0!==this.options.cache&&this.savePage.push({json:this.options.json??!1,data:c,deadline:new Date((new Date).getTime()+this.savePageDeadline),path:e.savePath}),this.send(c,t)})).catch((e=>r(this.error(e,t))))}}module.exports=(e,t=void 0)=>{let s;return(r,i,o)=>{void 0===s&&(s=new d(e,r.baseUrl,t)),s.options.strict&&"GET"!==r.method&&"HEAD"!==r.method&&(i.status(405),i.setHeader("Allow","GET, HEAD"),i.setHeader("Content-Length","0"),i.end());const a=s.path?s.parsePath(`${s.path}/${r.path}`):s.parsePath(r.path);s.path&&!a.length?o(s.error(400,i)):s.serve(a,i,o)}};
